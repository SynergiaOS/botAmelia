id: cerberus-monitoring
namespace: cerberus.monitoring

description: |
  System monitorowania Cerberus - sprawdza stan systemu, wydajnoÅ›Ä‡ i wysyÅ‚a alerty
  w przypadku problemÃ³w lub anomalii.

inputs:
  - id: alert_threshold_cpu
    type: FLOAT
    defaults: 80.0
    description: "PrÃ³g CPU dla alertÃ³w (%)"
  
  - id: alert_threshold_memory
    type: FLOAT
    defaults: 512.0
    description: "PrÃ³g pamiÄ™ci dla alertÃ³w (MB)"
  
  - id: alert_threshold_success_rate
    type: FLOAT
    defaults: 0.6
    description: "Minimalny success rate (0.0-1.0)"

variables:
  cerberus_api_base: "http://cerberus:8080"
  timeout: "PT30S"
  telegram_bot_token: "{{ secret('TELEGRAM_BOT_TOKEN') }}"
  telegram_chat_id: "{{ secret('TELEGRAM_CHAT_ID') }}"

tasks:
  # 1. Sprawdzenie podstawowego stanu systemu
  - id: basic-health-check
    type: io.kestra.plugin.core.http.Request
    uri: "{{ vars.cerberus_api_base }}/health"
    method: GET
    timeout: "{{ vars.timeout }}"
    description: "Podstawowe sprawdzenie stanu systemu"

  # 2. Pobranie szczegÃ³Å‚owych metryk
  - id: detailed-health-check
    type: io.kestra.plugin.core.http.Request
    uri: "{{ vars.cerberus_api_base }}/health/detailed"
    method: GET
    timeout: "{{ vars.timeout }}"
    description: "SzczegÃ³Å‚owe metryki systemu"

  # 3. Sprawdzenie metryk Prometheus
  - id: prometheus-metrics
    type: io.kestra.plugin.core.http.Request
    uri: "{{ vars.cerberus_api_base }}/metrics/prometheus"
    method: GET
    timeout: "{{ vars.timeout }}"
    description: "Pobranie metryk w formacie Prometheus"

  # 4. Analiza stanu systemu
  - id: analyze-system-state
    type: io.kestra.plugin.scripts.python.Script
    beforeCommands:
      - pip install requests
    script: |
      import json
      import re
      from datetime import datetime
      
      # Pobranie danych z poprzednich krokÃ³w
      health_data = {{ outputs['detailed-health-check'].body.data | tojson }}
      prometheus_text = """{{ outputs['prometheus-metrics'].body }}"""
      
      # Analiza metryk
      analysis = {
          "timestamp": datetime.now().isoformat(),
          "system_status": "healthy",
          "alerts": [],
          "warnings": [],
          "metrics": {}
      }
      
      # Sprawdzenie CPU
      cpu_usage = health_data.get("system", {}).get("cpu_usage_percent", 0)
      analysis["metrics"]["cpu_usage"] = cpu_usage
      if cpu_usage > {{ inputs.alert_threshold_cpu }}:
          analysis["alerts"].append({
              "type": "high_cpu",
              "message": f"Wysokie uÅ¼ycie CPU: {cpu_usage}%",
              "severity": "critical" if cpu_usage > 90 else "warning"
          })
          analysis["system_status"] = "warning"
      
      # Sprawdzenie pamiÄ™ci
      memory_usage = health_data.get("system", {}).get("memory_usage_mb", 0)
      analysis["metrics"]["memory_usage"] = memory_usage
      if memory_usage > {{ inputs.alert_threshold_memory }}:
          analysis["alerts"].append({
              "type": "high_memory",
              "message": f"Wysokie uÅ¼ycie pamiÄ™ci: {memory_usage}MB",
              "severity": "critical" if memory_usage > 1024 else "warning"
          })
          analysis["system_status"] = "warning"
      
      # Sprawdzenie success rate
      success_rate = health_data.get("trading", {}).get("success_rate", 1.0)
      analysis["metrics"]["success_rate"] = success_rate
      if success_rate < {{ inputs.alert_threshold_success_rate }}:
          analysis["alerts"].append({
              "type": "low_success_rate",
              "message": f"Niski success rate: {success_rate:.2%}",
              "severity": "warning"
          })
          analysis["system_status"] = "warning"
      
      # Sprawdzenie P&L
      daily_pnl = health_data.get("trading", {}).get("daily_pnl", 0)
      analysis["metrics"]["daily_pnl"] = daily_pnl
      if daily_pnl < -10:  # Straty powyÅ¼ej $10
          analysis["alerts"].append({
              "type": "high_losses",
              "message": f"Wysokie straty dzienne: ${daily_pnl:.2f}",
              "severity": "critical" if daily_pnl < -15 else "warning"
          })
          analysis["system_status"] = "critical"
      
      # Sprawdzenie czasu odpowiedzi
      avg_decision_time = health_data.get("performance", {}).get("avg_decision_time_ms", 0)
      analysis["metrics"]["avg_decision_time"] = avg_decision_time
      if avg_decision_time > 500:  # PowyÅ¼ej 500ms
          analysis["warnings"].append({
              "type": "slow_decisions",
              "message": f"Wolne decyzje: {avg_decision_time:.1f}ms",
              "severity": "info"
          })
      
      # Sprawdzenie bÅ‚Ä™dÃ³w bazy danych
      db_errors = health_data.get("database", {}).get("error_count", 0)
      analysis["metrics"]["db_errors"] = db_errors
      if db_errors > 0:
          analysis["warnings"].append({
              "type": "database_errors",
              "message": f"BÅ‚Ä™dy bazy danych: {db_errors}",
              "severity": "warning"
          })
      
      # OkreÅ›lenie ogÃ³lnego statusu
      if analysis["alerts"]:
          critical_alerts = [a for a in analysis["alerts"] if a["severity"] == "critical"]
          if critical_alerts:
              analysis["system_status"] = "critical"
          else:
              analysis["system_status"] = "warning"
      
      print(json.dumps(analysis, indent=2))

  # 5. Sprawdzenie czy sÄ… alerty krytyczne
  - id: check-critical-alerts
    type: io.kestra.plugin.core.flow.If
    condition: "{{ outputs['analyze-system-state'].vars.json.system_status == 'critical' }}"
    then:
      # WysÅ‚anie alertu krytycznego
      - id: send-critical-alert
        type: io.kestra.plugin.core.http.Request
        uri: "https://api.telegram.org/bot{{ vars.telegram_bot_token }}/sendMessage"
        method: POST
        contentType: "application/json"
        body: |
          {
            "chat_id": "{{ vars.telegram_chat_id }}",
            "text": "ğŸš¨ *ALERT KRYTYCZNY - Cerberus Trading Bot*\n\n{{ outputs['analyze-system-state'].vars.json.alerts | map(attribute='message') | join('\n') }}\n\nâ° Czas: {{ outputs['analyze-system-state'].vars.json.timestamp }}",
            "parse_mode": "Markdown"
          }
        allowFailed: true
        description: "WysÅ‚anie alertu krytycznego przez Telegram"
      
      - id: log-critical-alert
        type: io.kestra.plugin.core.log.Log
        message: |
          ğŸš¨ ALERT KRYTYCZNY:
          {{ outputs['analyze-system-state'].vars.json.alerts | map(attribute='message') | join('\n') }}
        level: ERROR

  # 6. Sprawdzenie czy sÄ… ostrzeÅ¼enia
  - id: check-warnings
    type: io.kestra.plugin.core.flow.If
    condition: "{{ outputs['analyze-system-state'].vars.json.system_status == 'warning' }}"
    then:
      # WysÅ‚anie ostrzeÅ¼enia
      - id: send-warning-alert
        type: io.kestra.plugin.core.http.Request
        uri: "https://api.telegram.org/bot{{ vars.telegram_bot_token }}/sendMessage"
        method: POST
        contentType: "application/json"
        body: |
          {
            "chat_id": "{{ vars.telegram_chat_id }}",
            "text": "âš ï¸ *OSTRZEÅ»ENIE - Cerberus Trading Bot*\n\n{{ outputs['analyze-system-state'].vars.json.alerts | map(attribute='message') | join('\n') }}\n\nâ° Czas: {{ outputs['analyze-system-state'].vars.json.timestamp }}",
            "parse_mode": "Markdown"
          }
        allowFailed: true
        description: "WysÅ‚anie ostrzeÅ¼enia przez Telegram"
      
      - id: log-warning
        type: io.kestra.plugin.core.log.Log
        message: |
          âš ï¸ OSTRZEÅ»ENIE:
          {{ outputs['analyze-system-state'].vars.json.alerts | map(attribute='message') | join('\n') }}
        level: WARN

  # 7. Sprawdzenie pozycji
  - id: check-positions
    type: io.kestra.plugin.core.http.Request
    uri: "{{ vars.cerberus_api_base }}/api/positions"
    method: GET
    timeout: "{{ vars.timeout }}"
    description: "Sprawdzenie aktywnych pozycji"

  # 8. Analiza pozycji
  - id: analyze-positions
    type: io.kestra.plugin.scripts.python.Script
    script: |
      import json
      
      positions_data = {{ outputs['check-positions'].body.data | tojson }}
      
      analysis = {
          "total_positions": positions_data.get("total_positions", 0),
          "total_value": positions_data.get("total_value", 0),
          "positions": positions_data.get("positions", []),
          "risk_alerts": []
      }
      
      # Sprawdzenie czy nie ma za duÅ¼o pozycji
      if analysis["total_positions"] > 3:
          analysis["risk_alerts"].append(f"Za duÅ¼o pozycji: {analysis['total_positions']}/3")
      
      # Sprawdzenie wartoÅ›ci pozycji
      if analysis["total_value"] > 1000:  # PrzykÅ‚adowy limit
          analysis["risk_alerts"].append(f"Wysoka wartoÅ›Ä‡ pozycji: ${analysis['total_value']:.2f}")
      
      print(json.dumps(analysis, indent=2))

  # 9. Raport dzienny (tylko o 18:00)
  - id: daily-report-check
    type: io.kestra.plugin.core.flow.If
    condition: "{{ now() | date('HH') == '18' }}"
    then:
      - id: generate-daily-report
        type: io.kestra.plugin.scripts.python.Script
        script: |
          import json
          from datetime import datetime
          
          health_data = {{ outputs['detailed-health-check'].body.data | tojson }}
          positions_data = {{ outputs['analyze-positions'].vars.json | tojson }}
          
          report = f"""
          ğŸ“Š *DZIENNY RAPORT CERBERUS*
          ğŸ“… Data: {datetime.now().strftime('%Y-%m-%d %H:%M')}
          
          ğŸ’° *FINANSE:*
          â€¢ Balans: ${health_data.get('trading', {}).get('current_balance', 0):.2f}
          â€¢ P&L dzienny: ${health_data.get('trading', {}).get('daily_pnl', 0):.2f}
          â€¢ Success rate: {health_data.get('trading', {}).get('success_rate', 0):.1%}
          
          ğŸ“ˆ *TRADING:*
          â€¢ SygnaÅ‚y: {health_data.get('trading', {}).get('total_signals', 0)}
          â€¢ Udane: {health_data.get('trading', {}).get('successful_trades', 0)}
          â€¢ Nieudane: {health_data.get('trading', {}).get('failed_trades', 0)}
          â€¢ Pozycje: {positions_data.get('total_positions', 0)}
          
          ğŸ–¥ï¸ *SYSTEM:*
          â€¢ CPU: {health_data.get('system', {}).get('cpu_usage_percent', 0):.1f}%
          â€¢ RAM: {health_data.get('system', {}).get('memory_usage_mb', 0):.0f}MB
          â€¢ Uptime: {health_data.get('system', {}).get('uptime_seconds', 0)//3600:.0f}h
          
          ğŸ“Š *WYDAJNOÅšÄ†:*
          â€¢ Åšr. czas decyzji: {health_data.get('performance', {}).get('avg_decision_time_ms', 0):.1f}ms
          â€¢ BÅ‚Ä™dy DB: {health_data.get('database', {}).get('error_count', 0)}
          """
          
          print(report)
      
      - id: send-daily-report
        type: io.kestra.plugin.core.http.Request
        uri: "https://api.telegram.org/bot{{ vars.telegram_bot_token }}/sendMessage"
        method: POST
        contentType: "application/json"
        body: |
          {
            "chat_id": "{{ vars.telegram_chat_id }}",
            "text": "{{ outputs['generate-daily-report'].vars.stdout }}",
            "parse_mode": "Markdown"
          }
        allowFailed: true
        description: "WysÅ‚anie dziennego raportu"

  # 10. Podsumowanie monitoringu
  - id: monitoring-summary
    type: io.kestra.plugin.core.log.Log
    message: |
      ğŸ“Š PODSUMOWANIE MONITORINGU:
      Status: {{ outputs['analyze-system-state'].vars.json.system_status }}
      CPU: {{ outputs['analyze-system-state'].vars.json.metrics.cpu_usage }}%
      RAM: {{ outputs['analyze-system-state'].vars.json.metrics.memory_usage }}MB
      Success Rate: {{ (outputs['analyze-system-state'].vars.json.metrics.success_rate * 100) | round(1) }}%
      P&L: ${{ outputs['analyze-system-state'].vars.json.metrics.daily_pnl }}
      Pozycje: {{ outputs['analyze-positions'].vars.json.total_positions }}
    level: INFO

errors:
  - id: monitoring-error-handler
    type: io.kestra.plugin.core.log.Log
    message: |
      ğŸ’¥ BÅÄ„D MONITORINGU:
      Task: {{ error.taskId }}
      Error: {{ error.message }}
    level: ERROR

triggers:
  # Monitoring co 2 minuty
  - id: continuous-monitoring
    type: io.kestra.plugin.core.trigger.Schedule
    cron: "*/2 * * * *"
    timezone: "Europe/Warsaw"
    disabled: false

  # Raport dzienny o 18:00
  - id: daily-report
    type: io.kestra.plugin.core.trigger.Schedule
    cron: "0 18 * * *"
    timezone: "Europe/Warsaw"
    disabled: false
